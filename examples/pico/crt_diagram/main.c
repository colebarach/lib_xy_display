// CRT Diagram Demo -----------------------------------------------------------------------------------------------------------
//
// Author: Cole Barach
//
// Description: Demonstration on how to render more complex images: Different shapes, colors, etc. The coordinates can be
//   generated and imported via external software like Blender or Krita.

// Libraries ------------------------------------------------------------------------------------------------------------------

// X-Y Library
#include <xy_renderer.h>

// I/O & Timing ---------------------------------------------------------------------------------------------------------------

#define X_PORT_OFFSET  0       // X port starts at GPIO 0
#define X_PORT_SIZE    8       // X port spans GPIO 0 to GPIO 7
#define Y_PORT_OFFSET  8       // Y port starts at GPIO 8
#define Y_PORT_SIZE    8       // Y port spans GPIO 8 to GPIO 15

#define Z_PIN          16      // Z output is GPIO 16
#define R_PIN          17      // Red color ouput is pin 17
#define G_PIN          18      // Green color output is pin 18
#define B_PIN          19      // Blue color output is pin 19

#define RC_CONSTANT_US 4       // RC constant of the output filter
#define RC_PIXEL_THRES 1       // Threshold of the cursor's accuracy

#define Z_DELAY_US     20      // Time to wait for z-output update

#define SCREEN_WIDTH  0x100    // Coordinates range [0, 255]
#define SCREEN_HEIGHT 0x100    // Coordinates range [0, 255]

// Models ---------------------------------------------------------------------------------------------------------------------

// Electron beam from heater to CRT screen
#define SIZE_BEAM_MODEL 71
xyPoint_t beamModel[SIZE_BEAM_MODEL] =
{
    { 42,  62}, { 41,  68}, { 44,  68}, { 47,  68}, { 51,  69}, { 56,  70}, { 60,  72}, { 65,  74},
    { 69,  76}, { 73,  78}, { 79,  78}, { 74,  77}, { 72,  76}, { 67,  74}, { 63,  72}, { 58,  70},
    { 54,  68}, { 49,  66}, { 46,  64}, { 42,  62}, { 47,  59}, { 47,  61}, { 49,  64}, { 53,  66},
    { 57,  68}, { 61,  70}, { 65,  72}, { 70,  74}, { 74,  76}, { 78,  79}, { 80,  79}, { 82,  81},
    { 87,  83}, { 92,  85}, { 97,  87}, {101,  89}, {106,  91}, {109,  93}, {112,  94}, {114,  95},
    {118,  96}, {122,  97}, {126,  98}, {131,  98}, {136, 100}, {141, 100}, {147, 101}, {152, 101},
    {158, 102}, {165, 103}, {172, 104}, {179, 104}, {184, 105}, {190, 106}, {194, 107}, {200, 107},
    {205, 108}, {210, 108}, {215, 109}, {220, 109}, {220, 104}, {220, 109}, {217, 107}, {220, 109},
    {217, 111}, {220, 109}, {220, 112}, {220, 109}, {222, 109}, {220, 109}, {224, 107}
};

// Back tube of the CRT
#define SIZE_TUBE1_MODEL 60
xyPoint_t tube1Model[SIZE_TUBE1_MODEL] =
{
    {104, 113}, { 99, 110}, { 95, 109}, { 91, 107}, { 87, 105}, { 83, 104}, { 79, 102}, { 76, 100},
    { 72,  99}, { 68,  97}, { 64,  95}, { 60,  93}, { 55,  91}, { 51,  89}, { 46,  87}, { 42,  85},
    { 37,  83}, { 32,  81}, { 28,  79}, { 23,  77}, { 18,  75}, { 14,  73}, { 11,  71}, {  9,  69},
    {  7,  66}, {  6,  63}, {  6,  59}, {  6,  56}, {  8,  51}, {  9,  48}, { 11,  46}, { 13,  43},
    { 15,  41}, { 18,  39}, { 21,  37}, { 24,  36}, { 28,  36}, { 32,  37}, { 36,  38}, { 40,  40},
    { 44,  42}, { 49,  44}, { 53,  46}, { 58,  48}, { 63,  50}, { 67,  52}, { 71,  54}, { 75,  56},
    { 80,  58}, { 85,  60}, { 90,  62}, { 94,  64}, { 99,  66}, {103,  68}, {107,  70}, {112,  72},
    {117,  74}, {121,  76}, {125,  78}, {129,  80}
};

// CRT screen
#define SIZE_TUBE2_MODEL 121
xyPoint_t tube2Model[SIZE_TUBE2_MODEL] =
{
    {160,  84}, {165,  82}, {170,  81}, {175,  79}, {180,  78}, {185,  77}, {191,  75}, {197,  74},
    {201,  73}, {206,  72}, {211,  70}, {215,  69}, {221,  68}, {225,  67}, {230,  65}, {236,  64},
    {241,  62}, {246,  61}, {251,  62}, {252,  66}, {252,  72}, {252,  78}, {252,  84}, {252,  90},
    {252,  96}, {252, 102}, {252, 108}, {252, 114}, {252, 120}, {252, 126}, {252, 132}, {252, 138},
    {252, 144}, {252, 150}, {252, 156}, {252, 162}, {252, 166}, {251, 169}, {247, 171}, {242, 173},
    {237, 175}, {231, 177}, {224, 179}, {218, 181}, {213, 184}, {207, 186}, {201, 188}, {196, 190},
    {186, 194}, {180, 196}, {174, 198}, {168, 200}, {163, 202}, {159, 203}, {155, 205}, {153, 205},
    {150, 203}, {148, 199}, {147, 194}, {145, 189}, {144, 183}, {142, 179}, {141, 175}, {140, 170},
    {138, 165}, {137, 160}, {136, 155}, {137, 160}, {138, 165}, {140, 170}, {141, 175}, {142, 179},
    {144, 183}, {145, 189}, {147, 194}, {148, 199}, {150, 203}, {153, 205}, {155, 205}, {155, 200},
    {155, 195}, {155, 190}, {155, 185}, {155, 180}, {155, 175}, {155, 170}, {155, 165}, {155, 160},
    {155, 155}, {155, 150}, {155, 145}, {155, 140}, {155, 135}, {155, 130}, {155, 125}, {155, 120},
    {155, 115}, {155, 110}, {155, 105}, {155, 100}, {155,  95}, {157,  91}, {160,  90}, {164,  89},
    {168,  88}, {172,  87}, {177,  85}, {183,  83}, {187,  82}, {193,  80}, {198,  79}, {202,  77},
    {207,  76}, {212,  75}, {217,  73}, {223,  73}, {229,  70}, {235,  68}, {241,  66}, {247,  64},
    {251,  62}
};

// Heater of the CRT
#define SIZE_HEATER_MODEL 42
xyPoint_t heaterModel[SIZE_HEATER_MODEL] =
{
    { 16,  60}, { 15,  56}, { 16,  52}, { 19,  49}, { 22,  47}, { 25,  46},
    { 20,  62}, { 19,  58}, { 20,  54}, { 23,  51}, { 26,  49}, { 29,  48},
    { 24,  64}, { 23,  60}, { 24,  56}, { 27,  53}, { 30,  51}, { 33,  50},
    { 28,  66}, { 27,  62}, { 28,  58}, { 31,  55}, { 34,  53}, { 37,  52},
    { 32,  68}, { 31,  64}, { 32,  60}, { 35,  57}, { 38,  55}, { 41,  54},
    { 36,  70}, { 35,  66}, { 36,  62}, { 39,  59}, { 42,  57}, { 45,  56},
    { 40,  72}, { 39,  68}, { 40,  64}, { 43,  61}, { 46,  59}, { 49,  58}
};

// Control grid around heater
#define SIZE_CONTROL_MODEL 108
xyPoint_t controlModel[SIZE_CONTROL_MODEL] =
{
    { 48,  51}, { 51,  52}, { 55,  54}, { 58,  56}, { 59,  59}, { 60,  62}, { 60,  65}, { 58,  70},
    { 56,  73}, { 54,  75}, { 51,  77}, { 48,  78}, { 44,  78}, { 41,  76}, { 37,  74}, { 31,  72},
    { 27,  70}, { 22,  68}, { 17,  66}, { 13,  64}, { 13,  61}, { 11,  57}, { 12,  53}, { 13,  50},
    { 15,  47}, { 17,  44}, { 20,  42}, { 22,  39}, { 20,  42}, { 17,  44}, { 15,  47}, { 12,  53},
    { 11,  57}, { 13,  61}, { 13,  64}, { 10,  62}, {  6,  59}, {  4,  58}, {  3,  58}, {  6,  56},
    {  8,  57}, {  6,  56}, {  3,  58}, {  4,  58}, {  6,  59}, { 10,  62}, {  8,  57}, {  8,  55},
    {  5,  54}, {  3,  53}, {  1,  52}, {  4,  51}, {  6,  52}, {  8,  53}, {  6,  52}, {  4,  51},
    {  1,  52}, {  3,  53}, {  5,  54}, {  8,  55}, {  8,  53}, {  9,  48}, {  7,  47}, {  5,  46},
    {  3,  43}, {  5,  43}, {  8,  44}, { 11,  46}, {  8,  44}, {  5,  43}, {  3,  43}, {  5,  46},
    {  7,  47}, {  9,  48}, { 11,  46}, { 13,  43}, { 11,  41}, {  8,  39}, { 10,  38}, { 13,  39},
    { 15,  41}, { 13,  39}, { 10,  38}, {  8,  39}, { 11,  41}, { 13,  43}, { 15,  41}, { 15,  41},
    { 18,  39}, { 22,  39}, { 26,  41}, { 30,  43}, { 34,  44}, { 38,  46}, { 41,  47}, { 44,  49},
    { 48,  51}, { 49,  54}, { 49,  57}, { 49,  60}, { 51,  63}, { 52,  65}, { 53,  66}, { 52,  68},
    { 49,  69}, { 47,  70}, { 45,  73}, { 41,  76},
};

// Horizontal deflection coil
#define SIZE_COIL1_MODEL 71
xyPoint_t coil1Model[SIZE_COIL1_MODEL] =
{
    {126,  82}, {129,  80}, {131,  78}, {136,  78}, {140,  79}, {144,  81}, {150,  82}, {155,  83},
    {160,  84}, {165,  84}, {170,  83}, {174,  83}, {177,  82}, {181,  81}, {185,  80}, {188,  80},
    {193,  80}, {196,  82}, {199,  85}, {200,  88}, {200,  92}, {200,  96}, {200, 100}, {200, 104},
    {200, 110}, {199, 114}, {197, 117}, {194, 121}, {191, 125}, {187, 127}, {182, 126}, {179, 125},
    {175, 123}, {170, 121}, {166, 119}, {162, 117}, {157, 114}, {151, 112}, {147, 110}, {143, 108},
    {139, 106}, {134, 104}, {129, 101}, {126,  98}, {126,  94}, {126,  90}, {126,  86}, {126,  82},
    {131,  83}, {137,  85}, {142,  87}, {147,  89}, {152,  90}, {157,  91}, {160,  90}, {164,  89},
    {168,  88}, {172,  87}, {177,  87}, {190,  88}, {193,  90}, {194,  95}, {195,  99}, {195, 103},
    {194, 107}, {194, 111}, {192, 114}, {191, 118}, {189, 121}, {186, 124}, {182, 126}
};

// Inner section of horizontal coil
#define SIZE_COIL2_MODEL 39
xyPoint_t coil2Model[SIZE_COIL2_MODEL] =
{
    {136,  87}, {141,  89}, {146,  91}, {152,  93}, {159,  93}, {164,  93}, {169,  94}, {174,  95},
    {177,  97}, {179, 100}, {179, 104}, {179, 108}, {177, 111}, {174, 112}, {170, 112}, {165, 112},
    {161, 111}, {158, 110}, {152, 108}, {148, 106}, {145, 104}, {141, 103}, {138, 101}, {135, 100},
    {131,  98}, {131,  94}, {131,  90}, {131,  85}, {136,  87}, {136,  91}, {136,  95}, {137,  99},
    {143, 102}, {149, 104}, {153, 106}, {158, 108}, {162, 109}, {166, 111}, {170, 112}
};

// Vertical deflection coil
#define SIZE_COIL3_MODEL 109
xyPoint_t coil3Model[SIZE_COIL3_MODEL] =
{
    {181, 135}, {182, 139}, {181, 144}, {178, 148}, {175, 151}, {171, 154}, {166, 156}, {161, 158},
    {156, 159}, {150, 159}, {145, 159}, {140, 158}, {136, 155}, {133, 150}, {132, 145}, {129, 140},
    {126, 135}, {123, 131}, {119, 127}, {115, 125}, {112, 122}, {108, 120}, {104, 118}, {103, 116},
    {104, 113}, {106, 112}, {113, 111}, {117, 109}, {120, 107}, {124, 104}, {128, 104}, {131, 106},
    {135, 108}, {139, 109}, {143, 111}, {147, 113}, {152, 115}, {155, 116}, {159, 119}, {163, 122},
    {167, 124}, {171, 127}, {175, 130}, {178, 133}, {181, 135}, {179, 140}, {175, 143}, {171, 147},
    {166, 150}, {160, 151}, {154, 152}, {149, 151}, {144, 151}, {140, 148}, {137, 145}, {135, 140},
    {133, 135}, {131, 131}, {129, 127}, {127, 124}, {123, 121}, {119, 119}, {115, 117}, {111, 115},
    {108, 113}, {106, 112}, {108, 113}, {111, 115}, {115, 113}, {119, 112}, {122, 110}, {126, 108},
    {122, 110}, {119, 112}, {115, 113}, {111, 115}, {115, 117}, {119, 119}, {123, 121}, {128, 122},
    {131, 125}, {134, 130}, {136, 133}, {139, 136}, {142, 138}, {146, 140}, {151, 140}, {156, 139},
    {160, 136}, {162, 132}, {162, 129}, {159, 126}, {155, 123}, {151, 120}, {147, 117}, {142, 115},
    {138, 113}, {134, 111}, {130, 109}, {126, 108}, {129, 112}, {131, 113}, {136, 115}, {141, 117},
    {145, 120}, {150, 122}, {154, 125}, {158, 128}, {162, 132}
};

// Focus grid
#define SIZE_FOCUS_MODEL 59
xyPoint_t focusModel[SIZE_FOCUS_MODEL] =
{
    { 73,  65}, { 75,  64}, { 79,  64}, { 82,  66}, { 86,  67}, { 89,  69}, { 93,  71}, { 96,  72},
    { 98,  75}, { 99,  80}, { 98,  84}, { 97,  90}, { 94,  93}, { 91,  95}, { 86,  96}, { 83,  96},
    { 84,  92}, { 83,  96}, { 79,  94}, { 75,  92}, { 71,  90}, { 67,  88}, { 69,  86}, { 73,  87},
    { 75,  85}, { 78,  82}, { 80,  79}, { 81,  75}, { 81,  71}, { 81,  75}, { 80,  79}, { 78,  82},
    { 75,  85}, { 73,  87}, { 76,  89}, { 80,  91}, { 84,  92}, { 88,  93}, { 92,  91}, { 95,  88},
    { 96,  85}, { 97,  80}, { 95,  76}, { 92,  74}, { 89,  74}, { 89,  72}, { 89,  74}, { 87,  74},
    { 83,  72}, { 81,  71}, { 79,  70}, { 76,  69}, { 73,  67}, { 73,  65}, { 78,  67}, { 83,  69},
    { 87,  71}, { 89,  72}, { 93,  71}
};

// First accelerating grid
#define SIZE_ACCELERATING1_MODEL 26
xyPoint_t accelerating1Model[SIZE_ACCELERATING1_MODEL] =
{
    { 64,  57}, { 67,  57}, { 70,  58}, { 72,  59}, { 74,  61}, { 75,  64}, { 75,  69}, { 75,  73},
    { 74,  77}, { 71,  81}, { 68,  84}, { 64,  86}, { 61,  87}, { 58,  86}, { 54,  85}, { 56,  83},
    { 58,  80}, { 60,  77}, { 62,  75}, { 64,  74}, { 65,  72}, { 64,  69}, { 63,  66}, { 63,  63},
    { 63,  59}, { 64,  57}
};

// Second accelerating grid
#define SIZE_ACCELERATING2_MODEL 23
xyPoint_t accelerating2Model[SIZE_ACCELERATING2_MODEL] =
{
    {100,  73}, {105,  73}, {108,  76}, {110,  80}, {111,  84}, {111,  88}, {109,  93}, {106,  97},
    {103, 100}, { 99, 102}, { 95, 103}, { 92, 102}, { 90, 100}, { 93,  97}, { 96,  93}, { 98,  90},
    {100,  90}, {101,  89}, {101,  87}, { 99,  85}, { 99,  80}, { 98,  75}, {100,  73}
};

#define MODEL_COUNT 11
xyPoint_t* models[MODEL_COUNT] =
{
    beamModel,
    tube1Model,
    tube2Model,
    heaterModel,
    controlModel,
    coil1Model,
    coil2Model,
    coil3Model,
    focusModel,
    accelerating1Model,
    accelerating2Model
};

int modelSizes[MODEL_COUNT] =
{
    SIZE_BEAM_MODEL,
    SIZE_TUBE1_MODEL,
    SIZE_TUBE2_MODEL,
    SIZE_HEATER_MODEL,
    SIZE_CONTROL_MODEL,
    SIZE_COIL1_MODEL,
    SIZE_COIL2_MODEL,
    SIZE_COIL3_MODEL,
    SIZE_FOCUS_MODEL,
    SIZE_ACCELERATING1_MODEL,
    SIZE_ACCELERATING2_MODEL
};

int modelColors[MODEL_COUNT * 3] =
{
      0, 255, 255, // Beam: Cyan
      0,   0, 255, // Tube: Blue
      0,   0, 255, // Tube: Blue
    255, 128,   0, // Heater: Orange
    255, 255,   0, // Control: Yellow
    255, 128,   0, // Coil: Orange
    255, 128,   0, // Coil: Orange
    255, 128,   0, // Coil: Orange
      0, 255,   0, // Focus grid: Green
    255,   0,   0, // Accelerating grid: Red
    255,   0,   0  // Accelerating grid: Red
};

volatile xyShape_t* shapes[MODEL_COUNT];

// Entrypoint -----------------------------------------------------------------------------------------------------------------

int main()
{
    // Initialize X-Y library
    xySetupXy(X_PORT_OFFSET, X_PORT_SIZE, Y_PORT_OFFSET, Y_PORT_SIZE);
    xySetupZ(Z_PIN);
    xySetupRgb(R_PIN, G_PIN, B_PIN);
    xySetupRcTiming(RC_CONSTANT_US, RC_PIXEL_THRES);
    xySetupRgbzDelay(Z_DELAY_US);
    xySetupScreen(SCREEN_WIDTH, SCREEN_HEIGHT, false);

    // Start rendering
    xyRendererStart();

    xyRendererStart();

    // Render diagram
    for(int index = 0; index < MODEL_COUNT; ++index)
    {
        // Mirror models along Y-axis because the imported coordinates are backwards.
        for(int pointIndex = 0; pointIndex < modelSizes[index]; ++pointIndex)
        {
            models[index][pointIndex].y = 255 - models[index][pointIndex].y;
        }

        // Render model
        shapes[index] = xyRenderShape(models[index], modelSizes[index], 0, 0, true);

        // Set model colors
        shapes[index]->colorRed   = modelColors[index * 3];
        shapes[index]->colorGreen = modelColors[index * 3 + 1];
        shapes[index]->colorBlue  = modelColors[index * 3 + 2];
    }

    // Spin
    while(1);
}
